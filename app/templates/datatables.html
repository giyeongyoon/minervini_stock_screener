<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¯¸ë„ˆë¹„ë‹ˆ ì „ëµ í•„í„° - DataTables.js</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
  </head>
  <body>
    <div class="container py-5">
      <h1 class="mb-4 text-center">ğŸ“ˆ Minervini ì „ëµ ì£¼ì‹ í•„í„°ë§</h1>

      <div class="text-center mb-4">
        <button id="filter-btn" class="btn btn-primary btn-lg">í•„í„°ë§ ì‹œì‘</button>
      </div>

      <div
        id="loading"
        class="alert alert-info text-center d-none d-flex align-items-center justify-content-center gap-3"
        role="alert"
      >
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <span class="fs-5">ì£¼ì‹ í•„í„°ë§ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</span>
      </div>

      <!-- DataTablesìš© í…Œì´ë¸” -->
      <table
        id="stock-table"
        class="display table table-striped"
        style="width: 100%; display: none;"
      >
        <thead>
          <tr>
            <th>ì¢…ëª©ëª…</th>
            <th>ì¢…ëª©ì½”ë“œ</th>
            <th>ì—…ì¢…</th>
            <th>í˜„ì¬ê°€</th>
            <th>RS</th>
            <th>BB</th>
            <th>low_volume</th>
            <th>is_contracting</th>
            <th>VCP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div
      class="modal fade"
      id="stockModal"
      tabindex="-1"
      aria-labelledby="stockModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="stockModalLabel">ì¢…ëª© ìƒì„¸ ì •ë³´</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ë‹«ê¸°"
            ></button>
          </div>
          <div class="modal-body" id="modal-body-content"></div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- Bootstrap Bundle JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    ></script>

    <script>
      const btn = document.getElementById("filter-btn");
      const loading = document.getElementById("loading");
      const table = $("#stock-table");
      let dataTable;

      btn.addEventListener("click", async () => {
        loading.classList.remove("d-none");

        // í…Œì´ë¸” ìˆ¨ê¸°ê¸° + ì´ˆê¸°í™”
        if (table && table.length > 0) table.hide();

        if (dataTable) {
            dataTable.clear().destroy();
            dataTable = null;
        }

        try {
          const response = await fetch("/filter", { method: "POST" });

          if (
            response.ok &&
            response.headers.get("content-type").includes("application/json")
          ) {
            const json = await response.json();

            if (json.status === "success") {
              // DataTables ë°ì´í„° í¬ë§·ì— ë§ê²Œ ë³€í™˜
              const stocks = json.data.map((stock) => ({
                ì¢…ëª©ëª…: stock.ì¢…ëª©ëª…,
                ì¢…ëª©ì½”ë“œ: stock.ì¢…ëª©ì½”ë“œ,
                ì—…ì¢…: stock.ì—…ì¢…ëª…,
                í˜„ì¬ê°€: Number(stock.í˜„ì¬ê°€).toLocaleString(),
                RS: Number(stock.Mansfield_RS).toFixed(1),
                BB: Number(stock.bb).toFixed(1),
                low_volume: stock.low_volume,
                is_contracting: stock.is_contracting,
                VCP: stock.vcp_ready,
                fullData: stock, // ìƒì„¸ ë°ì´í„° ì €ì¥
              }));

              // í…Œì´ë¸” í‘œì‹œ
              if (table && table.length > 0) table.show();

              // DataTable ì´ˆê¸°í™”
              dataTable = table.DataTable({
                data: stocks,
                columns: [
                  { data: "ì¢…ëª©ëª…" },
                  { data: "ì¢…ëª©ì½”ë“œ" },
                  { data: "ì—…ì¢…" },
                  { data: "í˜„ì¬ê°€" },
                  {
                    data: "RS",
                    render: function (data, type, row) {
                      const val = parseFloat(data);
                      let colorClass = "text-muted"; // ê¸°ë³¸: 0~10

                      if (val < 0) {
                        colorClass = "text-danger fw-bold"; // ì•½ì„¸
                      } else if (val >= 30) {
                        colorClass = "text-success fw-bold"; // ê°•ì„¸
                      } else if (val >= 10) {
                        colorClass = "text-warning fw-bold"; // ê¸ì •
                      }

                      return `<span class="${colorClass} fw-bold">${val}</span>`;
                    },
                  },
                  { data: "BB" },
                  { 
                    data: "low_volume",
                    render: function (data) {
                      return data
                        ? `<span class="text-success fw-bold">True</span>`
                        : `<span class="text-secondary fw-bold">False</span>`;
                    }, 
                  },
                  { 
                    data: "is_contracting",
                    render: function (data) {
                      return data
                        ? `<span class="text-success fw-bold">True</span>`
                        : `<span class="text-secondary fw-bold">False</span>`;
                    }, 
                  },
                  { 
                    data: "VCP",
                    render: function (data) {
                      return data
                        ? `<span class="text-success fw-bold">True</span>`
                        : `<span class="text-secondary fw-bold">False</span>`;
                    }, 
                  }
                ],
              });

              // í–‰ í´ë¦­ ì‹œ ëª¨ë‹¬ ë„ìš°ê¸°
              $("#stock-table tbody").off("click").on("click", "tr", function () {
                const rowData = dataTable.row(this).data();
                if (!rowData) return;

                const s = rowData.fullData;
                const modalBody = document.getElementById("modal-body-content");
                modalBody.innerHTML = `
                    <h5>${s.ì¢…ëª©ëª…} - ë¶„ê¸°ë³„ ì‹¤ì </h5>
                    <p>
                      <a href="https://m.stock.naver.com/domestic/stock/${s.ì¢…ëª©ì½”ë“œ}/finance/quarter" target="_blank" class="btn btn-primary">
                      ë„¤ì´ë²„ ê¸ˆìœµ ë¶„ê¸°ë³„ ì‹¤ì  ë°”ë¡œê°€ê¸°
                      </a>
                    </p>
                    `;

                const modal = new bootstrap.Modal(
                  document.getElementById("stockModal")
                );
                modal.show();
              });
            } else {
              alert(`âŒ ì‹¤íŒ¨: ${json.message}`);
            }
          } else {
            const text = await response.text();
            alert(`âš ï¸ ì˜¤ë¥˜: ${text}`);
          }
        } catch (e) {
          alert(`âŒ ì˜ˆì™¸ ë°œìƒ: ${e}`);
        } finally {
          loading.classList.add("d-none");
        }
      });
    </script>
  </body>
</html>
